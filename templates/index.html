<!doctype html>
<html lang="en">
<head>
  <meta name="theme-color" content="#0f0812">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8" />
  <title>PresentSer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/static/style.css">
</head>
<body class="bg">
  <div class="site-header">
    <div class="logo-wrap">
        <img src="/static/logo.png" class="logo" />
    </div>


    <p class="tag">Attendance made chill üòé</p>
</div>
    </header>

    <form id="calcForm" class="form">
      <div class="row">
        <label>Username (for save)</label>
        <input id="username" placeholder="optional: your name or id" />
      </div>

      <div class="row two">
        <div>
          <label>Present days</label>
          <input id="present" inputmode="decimal" placeholder="e.g. 6.5" />
        </div>
        <div>
          <label>Total days</label>
          <input id="total" inputmode="decimal" placeholder="e.g. 11" />
        </div>
      </div>

      <div class="row two">
        <div>
          <label>Gender</label>
          <select id="gender">
            <option value="">Prefer not to say</option>
            <option value="male">Male (75%)</option>
            <option value="female">Female (73%)</option>
          </select>
        </div>
        <div>
          <label>Custom target % (optional)</label>
          <input id="target" inputmode="numeric" placeholder="e.g. 80" />
        </div>
      </div>

      <div class="row actions">
        <button id="calcBtn" type="button" class="btn primary">Calculate</button>
       <!-- in your HTML where the reset button is rendered -->
<button id="resetBtn" type="button" class="btn" onclick="resetApp(); return false;">Reset</button>
        <button id="shareBtn" type="button" class="btn share-btn">Share</button>
      </div>
    </form>

    <div id="result" class="result hidden">
      <div id="statusBox" class="statusBox"></div>
      <div class="grid">
        <div class="tile">
          <div class="tile-title">Current %</div>
          <div id="curPct" class="big">‚Äî</div>
        </div>
        <div class="tile">
          <div class="tile-title">Days to reach target</div>
          <div id="reqDays" class="big">‚Äî</div>
        </div>
        <div class="tile">
          <div class="tile-title">Bunk-O-Meter</div>
          <div id="bunkDays" class="big">‚Äî</div>
        </div>
        <div class="tile">
          <div class="tile-title">Quip</div>
          <div id="quip" class="big small">‚Äî</div>
        </div>
      </div>
    </div>

  <!-- AD BANNER -->


    <footer class="footer">
    <!-- ====== Donate / Buy-me-a-tea button (replace your old donate link) ====== -->
<button id="buyTeaBtn" class="donate tea-btn" aria-haspopup="dialog" aria-controls="teaSheet">
  ‚òï Buy me a tea
</button>



<!-- ====== Bottom sheet ====== -->
<div id="teaSheet" class="sheet hidden" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="sheet-backdrop" id="sheetBackdrop"></div>
  <div class="sheet-panel" role="document" aria-labelledby="sheetTitle">
    <div class="sheet-handle"></div>

    <div class="sheet-content">
      <h3 id="sheetTitle">Buy me a tea ‚òï ‚Äî Thanks! üíú</h3>
      <p class="muted">If you like PresentSer, a ‚Çπ10 tea keeps it alive. Pick a payment method:</p>

      <div class="sheet-row">
        <div class="qr-wrap">
         <img src="/static/qr.png" class="qr-wrap" />
        </div>

        <div class="upi-info">
          <div class="upi-id-wrap">
            <label>UPI ID</label>
            <div class="upi-row">
              <code id="upiId">9544099148@slc</code>
              <button id="copyUpi" class="btn small">Copy</button>
            </div>
          </div>

          <div class="amounts">
            <label>Amount</label>
            <div class="amount-buttons">
              <button class="amtBtn" data-amt="10">‚Çπ10</button>
              <button class="amtBtn" data-amt="20">‚Çπ20</button>
              <button class="amtBtn" data-amt="50">‚Çπ50</button>
            </div>
          </div>

          <div class="actions">
            <a id="openUpi" class="btn primary full" href="#" target="_blank" rel="noopener">Open UPI app</a>
            <button id="copyUpiDeep" class="btn ghost full">Copy payment link</button>
          </div>
        </div>
      </div>

      <p class="muted small" style="margin-top:12px">Or scan QR using your UPI app.</p>

      <div class="sheet-footer">
        <button id="closeSheet" class="btn ghost">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- ====== End bottom sheet ====== -->
      <div class="about">Built by Fayas ‚Ä¢ Simple, fast, student-first.</div>
    </footer>
  </div>

  <footer class="legal-footer">
    <p>
         <a href="/about">About</a> ‚Ä¢
    <a href="/privacy">Privacy Policy</a> ‚Ä¢

    <a href="/contact">Contact</a>
    </p>
</footer>
 <!-- SHARE BUTTON (place next to Donate button) -->


<!-- Bottom sheet / dialog -->
<div id="shareSheet" class="share-sheet hidden" aria-hidden="true">
  <div id="sheetBackdrop" class="sheet-backdrop"></div>
  <div class="sheet">
    <div class="sheet-handle"></div>
    <h3>Share PresentSer</h3>
    <p class="sheet-sub">Share your attendance result or the app link</p>

    <div class="sheet-actions">
      <button id="shareLink" class="sheet-btn">üîó Share Link</button>
      <button id="shareText" class="sheet-btn">üìù Share Result Text</button>
      <button id="shareImage" class="sheet-btn">üñºÔ∏è Share Image</button>
      <button id="downloadImage" class="sheet-btn">‚¨áÔ∏è Download Image</button>
      <button id="copyLink" class="sheet-btn">üìã Copy Link</button>
    </div>

    <button id="sheetClose" class="sheet-close">Cancel</button>
  </div>
</div>

<!-- optional: html2canvas for image snapshot (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</div>

<!-- Toast -->
<div id="shareToast" class="toast hidden"></div>
 <!-- AD BANNER -->
<a href="https://www.instagram.com/fk_grandevents?igsh=MXBscmdqdzRlYXJ6MQ==" target="_blank" rel="noopener noreferrer" class="ad-wrapper">
    <div class="ad-banner">
        <div class="ad-content">
            <img src="/static/sponsor2.png" alt="Ad" class="ad-img" />
        </div>
        <div class="ad-tag">AD</div>
    </div>
</a>
<footer class="legal-footer">


<script>
const $ = id => document.getElementById(id);
const show = el => el.classList.remove('hidden');
const hide = el => el.classList.add('hidden');

async function calc() {
  const present = $('present').value.trim();
  const total = $('total').value.trim();
  const gender = $('gender').value;
  const target = $('target').value.trim();
  if (!present || !total) {
    alert("Enter present and total days.");
    return;
  }
  const body = { present, total, gender };
  if (target) body.target = target;

  const res = await fetch('/api/calc', {
    method: 'POST', headers: {'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  const data = await res.json();
  if (!data.ok) {
    alert(data.error || 'Error');
    return;
  }
  $('curPct').textContent = data.current_pct + '%';
  $('reqDays').textContent = (data.required_future_days === 0 ? 'Already at/above' : (data.required_future_days === null ? 'Not possible' : data.required_future_days + ' day(s)'));
  $('bunkDays').textContent = data.bunkable_days + ' day(s)';
  $('quip').textContent = data.quip;
  $('statusBox').textContent = `Target used: ${data.target_pct}% ‚Äî (${data.present} / ${data.total})`;
  show($('result'));
}

async function saveRec() {
  const username = $('username').value.trim();
  if (!username) {
    if (!confirm('No username given ‚Äî will save under "guest". Continue?')) return;
  }
  const present = $('present').value.trim();
  const total = $('total').value.trim();
  const gender = $('gender').value;
  const target = $('target').value.trim();
  if (!present || !total) { alert('Enter present and total to save.'); return; }
  const body = { username: username || 'guest', present, total, gender };
  if (target) body.target = target;
  const res = await fetch('/api/save', {
    method: 'POST', headers: {'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  const data = await res.json();
  if (data.ok) {
    alert('Saved ‚úÖ username: ' + data.username);
  } else {
    alert('Save failed');
  }
}

$('calcBtn').addEventListener('click', calc);
$('saveBtn').addEventListener('click', saveRec);
$('resetBtn').addEventListener('click', ()=> { ['present','total','target','username'].forEach(id=>$(id).value=''); hide($('result')); });

/* Donate link - replace with your real link (leave as placeholder) */
// UPI Donation Link
  const donateBtn = document.getElementById("donateBtn");

donateBtn.addEventListener("click", function () {
    const upiUrl =
      "upi://pay?pa=9544099148@slc&pn=Fayas&cu=INR&am=50&tn=Support%20PresentSer";

    window.location.href = upiUrl;
    const adEl = document.querySelector('.ad-banner'); // adjust selector if needed

function openTeaSheet() {
  if (!teaSheet) return;
  show(teaSheet);                         // your existing code
  if (adEl) adEl.classList.add('blurred'); // add blur + dim
}

function closeTeaSheet() {
  if (!teaSheet) return;
  hide(teaSheet);                         // your existing code
  if (adEl) adEl.classList.remove('blurred'); // remove blur
}
});
</script>
<script>
/* Advanced Share (inline) */
(function () {
  const shareBtn = document.getElementById("shareBtn");
  const sheet = document.getElementById("shareSheet");
  const sheetBackdrop = document.getElementById("sheetBackdrop");
  const sheetClose = document.getElementById("sheetClose");
  const shareLinkBtn = document.getElementById("shareLink");
  const shareTextBtn = document.getElementById("shareText");
  const shareImageBtn = document.getElementById("shareImage");
  const downloadImageBtn = document.getElementById("downloadImage");
  const copyLinkBtn = document.getElementById("copyLink");

  // small toast element (create if missing)
  let toast = document.getElementById("shareToast");
  if(!toast){
    toast = document.createElement("div");
    toast.id = "shareToast";
    toast.className = "toast hidden";
    document.body.appendChild(toast);
  }

  // Node we want to capture as image (adjust if your result element has other id)
  const resultNode = document.querySelector(".result") || document.querySelector(".card") || document.body;

  function showToast(msg, ms=1600){
    toast.textContent = msg;
    toast.classList.remove("hidden");
    toast.classList.add("show");
    setTimeout(()=>{ toast.classList.remove("show"); setTimeout(()=>toast.classList.add("hidden"), 220); }, ms);
  }

  function openSheet(){ sheet.classList.remove("hidden"); setTimeout(()=> sheet.classList.add("show"), 10); }
  function closeSheet(){ sheet.classList.remove("show"); setTimeout(()=> sheet.classList.add("hidden"), 240); }
  if(shareBtn) shareBtn.addEventListener("click", openSheet);
  if(sheetBackdrop) sheetBackdrop.addEventListener("click", closeSheet);
  if(sheetClose) sheetClose.addEventListener("click", closeSheet);

  shareLinkBtn && shareLinkBtn.addEventListener("click", async () => {
    const shareData = { title: "PresentSer ‚Äî Attendance made chill", text: "Check this out:", url: window.location.href };
    if (navigator.share) {
      try { await navigator.share(shareData); }
      catch(e){ showToast("Share cancelled"); }
    } else {
      try { await navigator.clipboard.writeText(window.location.href); showToast("Link copied"); }
      catch(e){ showToast("Copy failed"); }
    }
    closeSheet();
  });

  shareTextBtn && shareTextBtn.addEventListener("click", async () => {
    // try to build a human readable result ‚Äî adjust selectors to your page
    const pct = document.getElementById("currentPct")?.textContent ?? "";
    const days = document.getElementById("daysNeeded")?.textContent ?? "";
    const username = document.getElementById("username")?.value ?? "";
    const text = `PresentSer result${username ? " ‚Äî " + username : ""}\nCurrent: ${pct}\nDays to target: ${days}\nTry it: ${window.location.href}`;
    if (navigator.share) {
      try { await navigator.share({ title:"My PresentSer result", text, url: window.location.href }); }
      catch(e){ showToast("Share cancelled"); }
    } else {
      try { await navigator.clipboard.writeText(text); showToast("Result copied"); }
      catch(e){ showToast("Copy failed"); }
    }
    closeSheet();
  });

  // capture image (html2canvas required)
  async function captureImageNode(node){
    if (typeof html2canvas === "undefined") throw new Error("html2canvas not loaded");
    const canvas = await html2canvas(node, { backgroundColor: null, scale: Math.min(2, window.devicePixelRatio || 1) });
    const blob = await new Promise(res => canvas.toBlob(res, "image/png", 0.92));
    return blob;
  }

  shareImageBtn && shareImageBtn.addEventListener("click", async () => {
    try {
      const blob = await captureImageNode(resultNode);
      const file = new File([blob], "presentser-result.png", { type: "image/png" });
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({ files: [file], title: "PresentSer result", text: "My attendance snapshot" });
        showToast("Shared image");
      } else {
        const url = URL.createObjectURL(blob);
        window.open(url, "_blank");
        showToast("Image opened - long press to save/share");
      }
    } catch (err) {
      console.error(err);
      showToast("Image share failed");
    }
    closeSheet();
  });

  downloadImageBtn && downloadImageBtn.addEventListener("click", async () => {
    try {
      const blob = await captureImageNode(resultNode);
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "presentser-result.png"; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      showToast("Downloaded image");
    } catch (err) {
      console.error(err);
      showToast("Download failed");
    }
    closeSheet();
  });

  copyLinkBtn && copyLinkBtn.addEventListener("click", async () => {
    try { await navigator.clipboard.writeText(window.location.href); showToast("Link copied"); }
    catch(e){ showToast("Copy failed"); }
    closeSheet();
  });

  // disable image buttons if html2canvas missing
  window.addEventListener("load", () => {
    const imageReady = (typeof html2canvas !== "undefined");
    if (!imageReady) {
      shareImageBtn && shareImageBtn.setAttribute("disabled", "true");
      downloadImageBtn && downloadImageBtn.setAttribute("disabled", "true");
      shareImageBtn && (shareImageBtn.title = "Image capture requires html2canvas");
      downloadImageBtn && (downloadImageBtn.title = "Image capture requires html2canvas");
    }



  });
})();
</script>
<script>
/* QUICK PRESENTSER ENHANCEMENTS */
/* Helper */
const $ = id => document.getElementById(id);

/* Required elements (make sure these IDs exist) */
const presentEl = $('present');
const totalEl   = $('total');
const targetEl  = $('target');
const calcBtn   = $('calcBtn');
const currentPctEl = $('currentPct');
const daysNeededEl = $('daysNeeded');
const quipEl = $('quip');

/* --- LIVE % ANIMATION --- */
function animatePercent(toPct, duration = 800) {
  if (!currentPctEl) return;
  const from = parseFloat(currentPctEl.dataset.current || 0);
  const start = performance.now();
  function frame(now) {
    const t = Math.min(1, (now - start) / duration);
    const eased = 1 - Math.pow(1 - t, 3);
    const value = from + (toPct - from) * eased;
    currentPctEl.textContent = Math.round(value) + "%";
    if (t < 1) requestAnimationFrame(frame);
    else currentPctEl.dataset.current = toPct;
  }
  requestAnimationFrame(frame);
}

/* --- HAPTIC FEEDBACK --- */
function vibe() {
  if (navigator.vibrate) navigator.vibrate(15);
}

/* --- AUTOSAVE TO LOCAL STORAGE --- */
const LS_KEY = "presentser_autosave";

function saveLocal() {
  localStorage.setItem(
    LS_KEY,
    JSON.stringify({
      present: presentEl.value,
      total: totalEl.value,
      target: targetEl.value
    })
  );
}

function restoreLocal() {
  const saved = localStorage.getItem(LS_KEY);
  if (!saved) return;
  const data = JSON.parse(saved);
  if (presentEl) presentEl.value = data.present || "";
  if (totalEl) totalEl.value = data.total || "";
  if (targetEl) targetEl.value = data.target || "";
}

/* AUTOSAVE: whenever user types */
[presentEl, totalEl, targetEl].forEach(el => {
  if (!el) return;
  el.addEventListener("input", saveLocal);
});

/* CALCULATE BUTTON BEHAVIOR */
if (calcBtn) {
  calcBtn.addEventListener("click", () => {
    const p = parseFloat(presentEl.value || 0);
    const t = parseFloat(totalEl.value || 0);
    const tg = parseFloat(targetEl.value || 75);
    const pct = t > 0 ? (p/t*100) : 0;

    animatePercent(pct);
    vibe();
  });
}

/* restore previous session */
window.addEventListener("load", restoreLocal);
</script>
<script>
/*
  Client-side: call /api/calc to compute and update UI,
  then POST to /autosave to persist the form to presentser_data.json.

  IMPORTANT: make sure your form fields have these IDs:
    - username (string)
    - present  (number)
    - total    (number)
    - gender   (string)
    - target   (number, optional)
  If your inputs use other IDs, change getElementById(...) below.
*/

function getFormData() {
  return {
    username: document.getElementById('username')?.value?.trim() || '',
    present: document.getElementById('present')?.value || '',
    total: document.getElementById('total')?.value || '',
    gender: document.getElementById('gender')?.value || '',
    target: document.getElementById('target')?.value || ''
  };
}

// Apply calc result to UI ‚Äî adapt selectors if your result elements use different ids/classes.
function applyCalcResult(result) {
  // example: update fields; modify IDs to match your template
  // if you have specific output areas, change selectors accordingly
  const targetUsedEl = document.getElementById('targetUsed');
  const currentPctEl = document.getElementById('currentPct');
  const daysNeededEl = document.getElementById('daysNeeded');
  const bunkMeterEl = document.getElementById('bunkMeter');
  const quipEl = document.getElementById('quip');

  if (targetUsedEl) targetUsedEl.textContent = `Target used: ${result.target_pct}% ‚Äî (${result.present} / ${result.total})`;
  if (currentPctEl) currentPctEl.textContent = `${result.current_pct}%`;
  if (daysNeededEl) daysNeededEl.textContent = result.required_future_days === 0 ? 'Already at/above' : (result.required_future_days === null ? '‚Äî' : `${result.required_future_days} day(s)`);
  if (bunkMeterEl) bunkMeterEl.textContent = `${result.bunkable_days} day(s)`;
  if (quipEl) quipEl.textContent = result.quip;
}

async function callApiCalc(form) {
  try {
    const res = await fetch('/api/calc', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(form)
    });
    if (!res.ok) {
      const err = await res.json().catch(()=>({error:'calc_failed'}));
      console.warn('calc error', err);
      return null;
    }
    return await res.json();
  } catch (e) {
    console.warn('calc fetch failed', e);
    return null;
  }
}

async function autosave(form) {
  // send to /autosave (server will write presentser_data.json)
  try {
    await fetch('/autosave', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(form)
    });
    // silently ignore failures (non-blocking)
  } catch (e) {
    console.warn('autosave failed', e);
  }
}

// main calculate + autosave flow
document.getElementById('calcBtn').addEventListener('click', async function () {
  const form = getFormData();

  // 1) call calc API (gets back computed fields)
  const calc = await callApiCalc(form);
  if (calc && calc.ok) {
    applyCalcResult(calc);


// Reset button: clear inputs + recalc (optional)
document.getElementById('resetBtn').addEventListener('click', function () {
  ['username','present','total','gender','target'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  if (typeof doCalculate === 'function') doCalculate();
});

// Share button: simple navigator.share fallback; keep or replace as you like
document.getElementById('shareBtn').addEventListener('click', function () {
  const url = location.href;
  const text = `Check my attendance on PresentSer ‚Äî try this!`;
  if (navigator.share) {
    navigator.share({ title: 'PresentSer', text, url }).catch(()=>{});
  } else {
    // fallback: copy link to clipboard
    navigator.clipboard?.writeText(url).then(()=> alert('Link copied to clipboard'));
  }
});
</script>
<script>
(function(){

  // helper: find the first matching element/value for a list of selectors
  function findValue(selectors) {
    for (const s of selectors) {
      try {
        const el = document.querySelector(s);
        if (!el) continue;
        // inputs/selects
        if ('value' in el) return el.value;
        // if element contains text
        return el.textContent || el.innerText || "";
      } catch (e) { continue; }
    }
    return "";
  }

  // pick sensible selectors used in your project (adjust if you use different ids)
  const sel = {
    username: ['#username','input[name="username"]','#usernameEL','#usernameEl'],
    first_name: ['#first_name','input[name="first_name"]'],
    present: ['#present','input[name="present"]','#presentDays','input[name="present_days"]'],
    total: ['#total','input[name="total"]','#totalDays','input[name="total_days"]'],
    gender: ['#gender','select[name="gender"]','#genderSelect'],
    target: ['#target','input[name="target"]','#customTarget']
  };

  // build payload reading the best available element values
  function buildPayload() {
    const payload = {
      username: findValue(sel.username) || undefined,
      first_name: findValue(sel.first_name) || undefined,
      present: findValue(sel.present) || 0,
      total: findValue(sel.total) || 0,
      gender: findValue(sel.gender) || undefined,
      target: findValue(sel.target) || undefined
    };
    // convert empty strings to undefined so server falls back to defaults
    Object.keys(payload).forEach(k => {
      if (payload[k] === "") payload[k] = undefined;
    });
    return payload;
  }

  // autosave call
  async function autosave(payload) {
    try {
      const res = await fetch('/autosave', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        console.warn('autosave failed', await res.text());
      } else {
        // optional: console.info('autosave ok');
      }
    } catch (err) {
      console.warn('autosave error', err);
    }
  }

  // attach click listener to calculate button
  function attachSaveOnCalculate() {
    const btn = document.querySelector('#calculateBtn') || document.querySelector('.btn.primary');
    if (!btn) {
      // fallback: try to find by text "Calculate"
      const nodes = Array.from(document.querySelectorAll('button'));
      for (const n of nodes) if ((n.textContent||'').trim().toLowerCase()==='calculate') { btn = n; break; }
    }
    if (!btn) {
      console.warn('autosave: calculate button not found - add id="calculateBtn" to the Calculate button');
      return;
    }

    btn.addEventListener('click', function () {
      // delay slightly to allow any existing calculate logic to run first
      setTimeout(() => {
        const payload = buildPayload();
        // only save if present or total provided (avoid writing empty records)
        if ((Number(payload.present) || Number(payload.total)) !== 0 || payload.username) {
          autosave(payload);
        }
      }, 200); // 200ms is enough in most cases; increase if needed
    }, {passive: true});
  }

  // wait for DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attachSaveOnCalculate);
  } else {
    attachSaveOnCalculate();
  }

})();
</script>
<script>
(function(){
  const UPI_ID = '9544099148@slc';
  const RECIPIENT_NAME = 'Fayas';
  // default amount
  let amount = 10;

  const buyTeaBtn = document.getElementById('buyTeaBtn');
  const teaSheet = document.getElementById('teaSheet');
  const backdrop = document.getElementById('sheetBackdrop');
  const closeSheet = document.getElementById('closeSheet');
  const upiIdEl = document.getElementById('upiId');
  const copyUpi = document.getElementById('copyUpi');
  const copyUpiDeep = document.getElementById('copyUpiDeep');
  const openUpi = document.getElementById('openUpi');
  const upiQR = document.getElementById('upiQR');
  const amtButtons = Array.from(document.querySelectorAll('.amtBtn'));

  function buildUpiLink(amt){
    const pa = encodeURIComponent(UPI_ID);
    const pn = encodeURIComponent(RECIPIENT_NAME);
    const am = encodeURIComponent(String(amt));
    const tn = encodeURIComponent('Support PresentSer ‚Äî tea');
    return `upi://pay?pa=${pa}&pn=${pn}&am=${am}&tn=${tn}&cu=INR`;
  }

  function showSheet(){
    teaSheet.classList.remove('hidden');
    teaSheet.setAttribute('aria-hidden','false');
    // generate QR (Google charts). If you want offline QR you can swap method.
    const upiLink = buildUpiLink(amount);
    upiQR.src = 'https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=' + encodeURIComponent(upiLink);
    openUpi.href = upiLink;
  }

  function hideSheet(){
    teaSheet.classList.add('hidden');
    teaSheet.setAttribute('aria-hidden','true');
  }

  buyTeaBtn && buyTeaBtn.addEventListener('click', function(e){
    e.preventDefault();
    showSheet();
  });
  backdrop && backdrop.addEventListener('click', hideSheet);
  closeSheet && closeSheet.addEventListener('click', hideSheet);

  // copy simple UPI id
  copyUpi && copyUpi.addEventListener('click', async function(){
    try{
      await navigator.clipboard.writeText(UPI_ID);
      copyUpi.textContent = 'Copied';
      setTimeout(()=> copyUpi.textContent = 'Copy', 1400);
    }catch(e){
      alert('Copy your UPI ID: ' + UPI_ID);
    }
  });

  // copy deep link
  copyUpiDeep && copyUpiDeep.addEventListener('click', async function(){
    const link = buildUpiLink(amount);
    try{
      await navigator.clipboard.writeText(link);
      copyUpiDeep.textContent = 'Copied link';
      setTimeout(()=> copyUpiDeep.textContent = 'Copy payment link', 1600);
    }catch(e){
      alert('UPI link: ' + link);
    }
  });

  // amount buttons
  amtButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      amtButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      amount = Number(btn.dataset.amt || 10);
      // refresh QR and open link
      const upiLink = buildUpiLink(amount);
      upiQR.src = 'https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=' + encodeURIComponent(upiLink);
      openUpi.href = upiLink;
    });
  });

  // openUpi: users' device will try to open installed UPI apps with the upi:// scheme
  openUpi.addEventListener('click', function(){
    // small UX hint: link is set; on mobile this triggers app chooser
  });

  // keyboard escape to close
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && !teaSheet.classList.contains('hidden')) hideSheet();
  });

  // set initial UPI id text
  upiIdEl && (upiIdEl.textContent = UPI_ID);
function closeTeaSheet() {
    teaSheet.classList.add('hidden');
    document.querySelector('.ad-banner')?.classList.remove('hide-ad');
}
})();

</script>
  <script>
/* IDs used below assume your input elements:
   #present, #total, #gender, #target
   and these result containers: #currentPct, #daysToTarget, #bunkMeter, #quip
   adapt the IDs to your actual DOM if they differ.
*/

function resetCalculator() {
  // inputs
  const ids = ['present','total','gender','target','username'];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    if (el.tagName === 'SELECT') el.selectedIndex = 0;
    else el.value = '';
  });

  // UI outputs
  const outMap = {
    currentPct: '--%',
    daysToTarget: '‚Äî',
    bunkMeter: '‚Äî',
    quip: ''
  };
  Object.entries(outMap).forEach(([id, text]) => {
    const el = document.getElementById(id);
    if (el) el.textContent = text;
  });

  // If you show/hide result panel
  const resultPanel = document.querySelector('.result');
  if (resultPanel) { resultPanel.classList.add('hidden'); }

  // Reset any animated / pulse states
  const pct = document.getElementById('currentPct');
  if (pct) pct.classList.remove('pulse');

  // Clear localStorage if you saved state there (uncomment keys you use)
  // localStorage.removeItem('presentser_data');
  // localStorage.removeItem('presentser_user');
  // or clear all (careful)
  // localStorage.clear();

  // Focus first input so user can start typing
  const first = document.getElementById('present') || document.getElementById('username');
  if (first) first.focus();
}

// Hook the button ‚Äî adapt selector if your Reset button has different id/class
document.addEventListener('DOMContentLoaded', () => {
  const resetBtn = document.querySelector('#resetBtn, .btn-reset, button.reset, .reset');
  if (resetBtn) {
    resetBtn.addEventListener('click', (e) => {
      e.preventDefault(); // prevents accidental form submission
      resetCalculator();
      console.log('Reset done');
    });
  } else {
    console.warn('Reset button not found ‚Äî add id="resetBtn" to the Reset button.');
  }
});
</script>
  <script>
// generate or read visitor id
function visitorId(){
  let id = localStorage.getItem('presentser_vid');
  if(!id){
    id = crypto.randomUUID ? crypto.randomUUID() : 'vid-' + Date.now() + '-' + Math.random().toString(36).slice(2,9);
    localStorage.setItem('presentser_vid', id);
  }
  return id;
}

async function trackVisit(){
  const vid = visitorId();
  try{
    await fetch('/track', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({vid, path: location.pathname})
    });
  }catch(e){
    // ignore
  }
}

// fire on page load
window.addEventListener('load', trackVisit);
    // in your page js (on ad click)
document.getElementById("ad-banner").addEventListener("click", (e) => {
  fetch("/track/ad_click", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({target: "https://advertiser.example"})
  }).catch(()=>{});
  // then redirect to advertiser
  window.location.href = "https://advertiser.example";
  document.getElementById("liveUsers").innerText = data.live_users;
});
    fetch("/autosave", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    present,
    total,
    target,
    gender,
    username,
    vid: getVid()
  })
});
</script>
</body>
</html>