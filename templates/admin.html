<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PresentSer — Stats</title>
<link rel="stylesheet" href="/static/admin-admin.css" />
</head>
<body>
<header class="topbar">
  <div class="brand">PresentSer — Admin</div>
  <div class="meta">Auto-refresh: <span id="refreshInterval">10s</span></div>
</header>

<main class="container">
  <section class="cards">
    <div class="card">
      <div class="label">Total hits</div>
      <div class="value" id="total_hits">—</div>
    </div>
    <div class="card">
      <div class="label">Unique visitors</div>
      <div class="value" id="unique_visitors">—</div>
    </div>
    <div class="card">
      <div class="label">Today</div>
      <div class="value" id="today_hits">—</div>
    </div>
    <div class="card">
      <div class="label">Live (5m)</div>
      <div class="value" id="live">—</div>
    </div>
  </section>

  <section class="split">
    <div class="left">
      <div class="panel">
        <h3>Devices</h3>
        <div class="device-row">
          <div class="device-info">
            <div class="device-label">Mobile</div>
            <div class="device-value" id="device_mobile">0</div>
          </div>
          <div class="device-info">
            <div class="device-label">Desktop</div>
            <div class="device-value" id="device_desktop">0</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <h3>Last 7 days</h3>
        <div id="chart" class="chart"></div>
        <div class="chart-legend" id="chart-legend"></div>
      </div>
    </div>

    <div class="right">
      <div class="panel">
        <h3>Recent visits (10)</h3>
        <ul id="recent" class="recent-list"> <li class="muted">Loading...</li> </ul>
      </div>

      <div class="panel">
        <h3>Raw JSON</h3>
        <pre id="raw" class="raw">...</pre>
      </div>
    </div>
  </section>

  <footer class="footer">
    Built by Fayas • <a href="/">PresentSer</a>
  </footer>
</main>

<script>
const API = '/stats';
async function fetchStats(){
  try{
    const res = await fetch(API, {cache: "no-store"});
    if(!res.ok) throw new Error('fetch error');
    const j = await res.json();
    render(j);
  }catch(e){
    console.error(e);
    document.getElementById('raw').textContent = 'Error fetching /stats';
  }
}

function render(data){
  // cards
  document.getElementById('total_hits').textContent = data.total_hits ?? 0;
  document.getElementById('unique_visitors').textContent = data.unique_visitors ?? 0;
  document.getElementById('today_hits').textContent = data.today_hits ?? 0;
  document.getElementById('live').textContent = data.live ?? 0;

  // devices
  const dev = data.devices || {mobile:0, desktop:0};
  document.getElementById('device_mobile').textContent = dev.mobile ?? 0;
  document.getElementById('device_desktop').textContent = dev.desktop ?? 0;

  // last 7 days chart
  const last7 = data.last_7_days || {};
  const keys = Object.keys(last7);
  const values = keys.map(k => last7[k] || 0);
  const max = Math.max(1, ...values);
  const chart = document.getElementById('chart');
  chart.innerHTML = '';
  keys.forEach((k, idx) => {
    const v = values[idx];
    const bar = document.createElement('div');
    bar.className = 'bar';
    bar.style.height = (v / max * 100) + '%';
    bar.title = k + ': ' + v;
    const lbl = document.createElement('div');
    lbl.className = 'bar-label';
    lbl.textContent = k.slice(5); // show MM-DD
    bar.appendChild(lbl);
    chart.appendChild(bar);
  });

  // recent list
  const recent = data.recent || [];
  const rEl = document.getElementById('recent');
  rEl.innerHTML = '';
  if(recent.length === 0){
    rEl.innerHTML = '<li class="muted">No recent visits</li>';
  } else {
    recent.forEach(item => {
      const li = document.createElement('li');
      const t = new Date((item.last_seen||0)*1000);
      li.innerHTML = '<div class="r-line"><b>' + (item.path || '/') + '</b> <span class="muted"> — ' + t.toLocaleString() + '</span></div>';
      rEl.appendChild(li);
    });
  }

  // raw
  document.getElementById('raw').textContent = JSON.stringify(data, null, 2);
}

// auto-refresh every N seconds
const INTERVAL = 10;
document.getElementById('refreshInterval').textContent = INTERVAL + 's';
fetchStats();
setInterval(fetchStats, INTERVAL*1000);
</script>
</body>
</html>